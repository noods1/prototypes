import{r as t,h as i,H as e}from"./p-BVbYP5UG.js";import"@oddbird/popover-polyfill";const s=':host{display:flex;width:100%;height:100%;justify-content:center;align-items:center}.crop-container{position:relative;user-select:none;display:inline-block;vertical-align:top}.crop-container-width{width:100%}.crop-container-height{height:100%}.crop-container::after{content:"";height:100%;width:100%;top:0;left:0;position:absolute;background-color:var(--ks-color-neutral-overlay)}.crop-container .crop-image-container{position:relative;width:100%;height:100%;overflow:hidden}.crop-container .crop-image-container .crop-source-image{display:block;user-select:none;pointer-events:none}.crop-container .crop-image-container .crop-source-image.image-upper{position:absolute;top:0;left:0;z-index:9}.crop-container .crop-image-container .crop-source-image-width{width:100%;height:auto}.crop-container .crop-image-container .crop-source-image-height{height:100%;width:auto}.crop-container .crop-selection-box{position:absolute;border:1px dashed var(--ks-color-neutral-fillLow);box-sizing:border-box;cursor:move;z-index:10}.crop-container .crop-selection-box .crop-grid{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;box-sizing:border-box}.crop-container .crop-selection-box .crop-grid .grid-line{position:absolute;pointer-events:none}.crop-container .crop-selection-box .crop-grid .grid-line.vertical-1{left:33.3333333333%;top:0;bottom:0;border-left:0.5px dashed var(--ks-color-neutral-fillLow);height:100%}.crop-container .crop-selection-box .crop-grid .grid-line.vertical-2{left:66.6666666667%;top:0;bottom:0;border-left:0.5px dashed var(--ks-color-neutral-fillLow);height:100%}.crop-container .crop-selection-box .crop-grid .grid-line.horizontal-1{top:33.3333333333%;left:0;right:0;border-top:0.5px dashed var(--ks-color-neutral-fillLow)}.crop-container .crop-selection-box .crop-grid .grid-line.horizontal-2{top:66.6666666667%;left:0;right:0;border-top:0.5px dashed var(--ks-color-neutral-fillLow)}.crop-container .crop-selection-box .crop-handle{position:absolute;box-sizing:border-box}.crop-container .crop-selection-box .crop-handle.handle-top-left{top:0;left:0;cursor:nwse-resize;transform:translate(-50%, -50%)}.crop-container .crop-selection-box .crop-handle.handle-top-center{top:-1px;left:50%;cursor:ns-resize;transform:translate(-50%, -50%)}.crop-container .crop-selection-box .crop-handle.handle-top-right{top:0;right:0;cursor:nesw-resize;transform:translate(50%, -50%)}.crop-container .crop-selection-box .crop-handle.handle-middle-left{top:50%;left:-1px;cursor:ew-resize;transform:translate(-50%, -50%)}.crop-container .crop-selection-box .crop-handle.handle-middle-right{top:50%;right:-1px;cursor:ew-resize;transform:translate(50%, -50%)}.crop-container .crop-selection-box .crop-handle.handle-bottom-left{bottom:0;left:0;cursor:nesw-resize;transform:translate(-50%, 50%)}.crop-container .crop-selection-box .crop-handle.handle-bottom-center{bottom:-1px;left:50%;cursor:ns-resize;transform:translate(-50%, 50%)}.crop-container .crop-selection-box .crop-handle.handle-bottom-right{bottom:0;right:0;cursor:nwse-resize;transform:translate(50%, 50%)}';const o="crop";const h=class{constructor(i){t(this,i);this["ks-name"]="ks-crop";this.src="";this.ratio="custom";this.imageType="image/jpeg";this.imageQuality=.9;this.sizeMode="width";this.fixedRect=false;this.circle=false;this.cropRect={width:120,height:120};this.initCrop={width:120,height:120};this.isDragging=false;this.isResizing=false;this.moving=false;this.resizeObserver=null;this.minWidth=38;this.minHeight=38;this.resizeHandle=null;this.startX=0;this.startY=0;this._ratio="custom";this.handleMouseDown=(t,i)=>{if(this.resizeHandle)return;t.stopPropagation();t.preventDefault();switch(i){case"move":this.isDragging=true;this.startX=t.clientX;this.startY=t.clientY;break;case"topLeft":case"top":case"topRight":case"left":case"right":case"bottomLeft":case"bottom":case"bottomRight":this.isResizing=true;this.resizeHandle=i;this.startX=t.clientX;this.startY=t.clientY;break}};this.handleDefaultLeftDrag=(t,i,e)=>{let s=0;if(t>0){const e=i-this.minWidth;s=t<e?t:e}if(t<0){const i=e;s=-t<i?t:-i}return s};this.handleDefaultRightDrag=(t,i,e)=>{let s=0;if(t>0){const o=this.el.clientWidth-i-e;s=t<o?t:o}if(t<0){const e=i-this.minWidth;s=-t<e?t:-e}return s};this.handleDefaultTopDrag=(t,i,e)=>{let s=0;if(t>0){const e=i-this.minHeight;s=t<e?t:e}if(t<0){const i=e;s=-t<i?t:-i}return s};this.handleDefaultBottomDrag=(t,i,e)=>{let s=0;if(t>0){const o=this.el.clientHeight-i-e;s=t<o?t:o}if(t<0){const e=i-this.minHeight;s=-t<e?t:-e}return s};this.handleRatioLeftDrag=(t,i,e,s,o)=>{let h=0;if(t>0){const e=i-this.minWidth;h=t<e?t:e}if(t<0){const i=e;const r=Math.max(o,this.el.clientHeight-o-s)*2;const n=-t<i?t:-i;const c=Math.round(r/this.getRatioRes);if(-n>c){h=-Math.round(c*this.getRatioRes)}else{h=n}}return[h,h*this.getRatioRes]};this.handleRatioRightDrag=(t,i,e,s,o)=>{let h=0;if(t<0){h=this.handleDefaultRightDrag(t,i,e)}if(t>0){const r=this.el.clientWidth-e-i;const n=Math.max(o,this.el.clientHeight-o-s)*2;const c=t<r?t:r;const a=Math.round(n/this.getRatioRes);if(c>a){h=Math.round(a*this.getRatioRes)}else{h=c}}return[h,h*this.getRatioRes]};this.handleRatioTopDrag=(t,i,e,s,o)=>{let h=0;if(t>0)h=this.handleDefaultTopDrag(t,i,e);else{const i=e;const r=Math.max(o,this.el.clientWidth-o-s)*2;const n=-t<i?t:-i;const c=Math.round(r/this.getRatioRes);if(-n>c){h=-Math.round(c*this.getRatioRes)}else{h=n}}return[h,h/this.getRatioRes]};this.handleRatioBottomDrag=(t,i,e,s,o)=>{let h=0;if(t<0)h=this.handleDefaultBottomDrag(t,i,e);else{const r=this.el.clientHeight-e-i;const n=Math.max(o,this.el.clientWidth-o-s)*2;const c=t<r?t:r;const a=Math.round(n/this.getRatioRes);if(c>a){h=Math.round(a*this.getRatioRes)}else{h=c}}return[h,h/this.getRatioRes]};this.handleMouseMove=t=>{if(this.moving||!this.isResizing&&!this.isDragging)return;this.moving=true;if(this.isDragging){this.handleDragMove(t.clientX-this.startX,t.clientY-this.startY);this.startX=t.clientX;this.startY=t.clientY}else if(this.isResizing&&this.resizeHandle){const{clientX:i,clientY:e}=t;const s=i-this.startX;const o=e-this.startY;this.startX=i;this.startY=e;if(this._ratio==="custom"){this.handleResizeMoveCustom(s,o)}else{this.handleResizeMoveRatio(s,o)}}this.moving=false};this.handleMouseUp=()=>{this.isDragging=false;this.isResizing=false;this.resizeHandle=null}}async screenshot(){const t=document.createElement("canvas");const i=this.imageRef.naturalWidth/this.imageRef.width;const{x:e,y:s,width:o,height:h}=this.cropRect;t.width=o*i;t.height=h*i;const r=t.getContext("2d");r.drawImage(this.imageRef,e*i,s*i,o*i,h*i,0,0,o*i,h*i);const n=await new Promise((i=>{t.toBlob((t=>{if(t){const e=URL.createObjectURL(t);i(e)}}),this.imageType,this.imageQuality)}));return n}async getCropRect(){const t=this.imageRef.naturalWidth/this.imageRef.width||1;const{x:i,y:e,width:s,height:o}=this.cropRect;return{x:i*t,y:e*t,width:s*t,height:o*t}}get getRatioRes(){const t=this._ratio.split(":").map((t=>parseInt(t)));return t[0]/t[1]}handleDragMove(t,i){let{x:e,y:s}=this.cropRect;const{width:o,height:h}=this.cropRect;e+=t;s+=i;if(e<0)e=0;if(s<0)s=0;if(e+o>this.el.clientWidth)e=this.el.clientWidth-o;if(s+h>this.el.clientHeight)s=this.el.clientHeight-h;this.cropRect={x:e,y:s,width:o,height:h}}handleResizeMoveCustom(t,i){let{x:e,y:s,width:o,height:h}=this.cropRect;switch(this.resizeHandle){case"topLeft":{const r=this.handleDefaultTopDrag(i,h,s);s+=r;h-=r;const n=this.handleDefaultLeftDrag(t,o,e);e+=n;o-=n;break}case"top":{const t=this.handleDefaultTopDrag(i,h,s);s+=t;h-=t;break}case"topRight":{const r=this.handleDefaultTopDrag(i,h,s);s+=r;h-=r;o+=this.handleDefaultRightDrag(t,o,e);break}case"left":{const i=this.handleDefaultLeftDrag(t,o,e);e+=i;o-=i;break}case"right":{o+=this.handleDefaultRightDrag(t,o,e);break}case"bottomLeft":{h+=this.handleDefaultBottomDrag(i,h,s);const r=this.handleDefaultLeftDrag(t,o,e);e+=r;o-=r;break}case"bottom":{h+=this.handleDefaultBottomDrag(i,h,s);break}case"bottomRight":{h+=this.handleDefaultBottomDrag(i,h,s);o+=this.handleDefaultRightDrag(t,o,e);break}}this.cropRect={x:e,y:s,width:Math.max(this.minWidth,o),height:Math.max(this.minHeight,h)}}handleResizeMoveRatio(t,i){let{x:e,y:s,width:o,height:h}=this.cropRect;switch(this.resizeHandle){case"topLeft":{const[i,r]=this.handleRatioLeftDrag(t,o,e,h,s);e+=i;o-=i;h-=r;s+=r/2;break}case"top":{const[t,r]=this.handleRatioTopDrag(i,h,s,o,e);s+=t;h-=t;e+=r/2;o-=r;break}case"topRight":{const[i,r]=this.handleRatioRightDrag(t,o,e,h,s);o+=i;h+=r;s-=r/2;break}case"left":{const[i,r]=this.handleRatioLeftDrag(t,o,e,h,s);e+=i;o-=i;h-=r;s+=r/2;break}case"right":{const[i,r]=this.handleRatioRightDrag(t,o,e,h,s);o+=i;h+=r;s-=r/2;break}case"bottomLeft":{const[i,r]=this.handleRatioLeftDrag(t,o,e,h,s);e+=i;o-=i;h-=r;s+=r/2;break}case"bottom":{const[t,r]=this.handleRatioBottomDrag(i,h,s,o,e);o+=r;h+=t;e-=r/2;break}case"bottomRight":{const[i,r]=this.handleRatioRightDrag(t,o,e,h,s);o+=i;h+=r;s-=r/2;break}}if(e+o>this.el.clientWidth)e=this.el.clientWidth-o;if(s+h>this.el.clientHeight)s=this.el.clientHeight-h;this.cropRect={x:Math.max(e,0),y:Math.max(s,0),width:Math.max(this.minWidth,o),height:Math.max(this.minHeight,h)}}onRatioChange(){if(this.circle){this._ratio="1:1"}else{this._ratio=this.ratio}if(this._ratio!=="custom"){if(this.getRatioRes>1){this.minWidth=38;this.minHeight=this.getRatioRes*this.minWidth}else if(this.getRatioRes<1){this.minHeight=38;this.minWidth=this.minHeight/this.getRatioRes}}this.onInitialCropRectChange()}onInitialCropRectChange(){const t={...this.initCrop,...this.initialCropRect};if(this._ratio!=="custom"){const i=t.width*this.getRatioRes;t.height=i}const{x:i,y:e,width:s,height:o}=t;if(i===undefined||e===undefined){t.x=(this.imageRef.clientWidth-s)/2;t.y=(this.imageRef.clientHeight-o)/2}this.cropRect=t}onSrcChange(){this.onRatioChange()}onMouseMove(t){this.handleMouseMove(t)}onMouseUp(){this.handleMouseUp()}renderDotDrag(t){return i("svg",{onMouseDown:i=>{this.handleMouseDown(i,t)},class:`${o}-handle handle-${this.camelToKebab(t)}`,xmlns:"http://www.w3.org/2000/svg",width:"12",height:"12",viewBox:"0 0 12 12",fill:"none","data-testid":"ks-crop-index-odoH6v"},i("path",{d:"M6 11C8.76142 11 11 8.76142 11 6C11 3.23858 8.76142 1 6 1C3.23858 1 1 3.23858 1 6C1 8.76142 3.23858 11 6 11Z",fill:"white",stroke:"#121415"}))}camelToKebab(t){return t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}renderHorizontalSideDrag(t){return i("svg",{onMouseDown:i=>{this.handleMouseDown(i,t)},class:`${o}-handle handle-${t}-center`,xmlns:"http://www.w3.org/2000/svg",width:"26",height:"8",viewBox:"0 0 26 8",fill:"none","data-testid":"ks-crop-index-22LCrK"},i("path",{d:"M22 7C23.6569 7 25 5.65685 25 4C25 2.34315 23.6569 1 22 1L4 1C2.34315 1 1 2.34315 1 4C1 5.65685 2.34315 7 4 7L22 7Z",fill:"white",stroke:"#121415"}))}renderVerticalSideDrag(t){return i("svg",{onMouseDown:i=>{this.handleMouseDown(i,t)},class:`${o}-handle handle-middle-${t}`,xmlns:"http://www.w3.org/2000/svg",width:"8",height:"25",viewBox:"0 0 8 25",fill:"none","data-testid":"ks-crop-index-qHkLJh"},i("path",{d:"M7 3.5C7 1.84315 5.65685 0.5 4 0.5C2.34315 0.5 1 1.84315 1 3.5L1 21.5C1 23.1569 2.34315 24.5 4 24.5C5.65685 24.5 7 23.1569 7 21.5L7 3.5Z",fill:"white",stroke:"#121415"}))}componentDidLoad(){this.resizeObserver=new ResizeObserver((()=>{if(this.imageRef.clientHeight&&this.imageRef.clientWidth){this.onRatioChange()}}));this.resizeObserver.observe(this.imageRef)}render(){const t=this.cropRect.width/2;const s=this.circle?`circle(${t}px at ${this.cropRect.x+t}px ${this.cropRect.y+t}px)`:`rect(${this.cropRect.y}px ${this.cropRect.x+this.cropRect.width}px ${this.cropRect.y+this.cropRect.height}px ${this.cropRect.x}px)`;const h={clipPath:s};const r={position:"absolute",left:`${this.cropRect.x}px`,top:`${this.cropRect.y}px`,width:`${this.cropRect.width}px`,height:`${this.cropRect.height}px`};return i(e,{key:"56385fe3a955614f99cc1d4c906c05326ba2eab2","ks-name":"ks-crop"},i("div",{key:"1ea91a1a3680d957b8eb6c504b70314652b02947",ref:t=>this.el=t,class:`${o}-container ${o}-container-${this.sizeMode}`},i("div",{key:"c97098ae425f168a1a0274136b6af07b593cec0b",class:`${o}-image-container`},i("img",{key:"90d04a21d4ab11a93c63bc43ba767020a0d843af",src:this.src,class:`${o}-source-image ${o}-source-image-${this.sizeMode} image-background`}),i("img",{key:"b07560a01a411a9e4ae4169da8b01cf0d8a9eee7",ref:t=>this.imageRef=t,style:h,src:this.src,class:`${o}-source-image ${o}-source-image-${this.sizeMode} image-upper`,crossOrigin:"anonymous","data-testid":"ks-crop-index-tPTwK9"})),i("div",{key:"ebd506124a66e7b629dd332491a415da4c9cc8de",class:`${o}-selection-box`,onMouseDown:t=>{this.handleMouseDown(t,"move")},style:r,"data-testid":"ks-crop-index-aWNikt"},i("div",{key:"ce70bdedabc23dbdeb74163b6e91fe753f7bcb52",class:`${o}-grid`},i("div",{key:"400934096cfc5208d4ca3d5133a431eb2f3af705",class:"grid-line vertical-1"}),i("div",{key:"50ace8cef4d2dc12656c2d34c9964f645919e7af",class:"grid-line vertical-2"}),i("div",{key:"b68b711a3d95c9c3e9621db05154a642bd3ad380",class:"grid-line horizontal-1"}),i("div",{key:"4bcb1423e7339db179ffb4ce7cf85e7dbc8dde1a",class:"grid-line horizontal-2"})),!this.fixedRect&&[this.renderDotDrag("topLeft"),this.renderDotDrag("topRight"),this.renderDotDrag("bottomLeft"),this.renderDotDrag("bottomRight"),this.renderHorizontalSideDrag("top"),this.renderHorizontalSideDrag("bottom"),this.renderVerticalSideDrag("left"),this.renderVerticalSideDrag("right")])))}static get watchers(){return{ratio:["onRatioChange"],initialCropRect:["onInitialCropRectChange"],src:["onSrcChange"]}}};h.style=s;export{h as ks_crop};